# Firebase Usage Monitoring Setup

## Overview

The `freeTierMonitor` service automatically tracks all Firestore read/write/delete operations and provides:
- Daily usage statistics
- Real-time warnings when approaching free tier limits
- Cost estimation for overage usage
- Usage projection for the full month

## Integration Status

### ‚úÖ Completed
1. **freeTierMonitor.ts** - Created and fully operational
   - Tracks reads, writes, deletes
   - Calculates estimated costs
   - Provides warnings at 80% threshold
   - Stores stats in localStorage
   - Exports stats for analysis

2. **firestoreCache.ts** - Integrated monitoring
   - Records 1 read per cache miss
   - Cache hits don't count toward limit
   - Expected reduction: 60-80%

3. **queryOptimizer.ts** - Integrated monitoring
   - Records 1 read per query execution
   - Pagination reduces reads naturally
   - Search and batch operations tracked

### üîÑ Pending Integration

The following services need to call `freeTierMonitor` methods:

#### High Priority (Daily Usage Heavy)
- `projectService.ts` - getProjects(), getProjectsByStatus(), search()
  - Estimated reads/day: 500+
  - Action: Add `freeTierMonitor.recordRead(1)` after `getDocs()` calls

- `userService.ts` - getUsers(), getUsersByDepartment()
  - Estimated reads/day: 200+
  - Action: Add `freeTierMonitor.recordRead(1)` after `getDocs()` calls

- `documentService.ts` - getDocuments(), getDocumentsByProject()
  - Estimated reads/day: 300+
  - Action: Add `freeTierMonitor.recordRead(1)` after `getDocs()` calls

#### Medium Priority
- All update/delete operations should call:
  - `freeTierMonitor.recordWrite(1)` after `setDoc()`, `updateDoc()`
  - `freeTierMonitor.recordDelete(1)` after `deleteDoc()`

## Usage Examples

### In Services (After Firestore Operations)

```typescript
// projectService.ts
import { freeTierMonitor } from './freeTierMonitor';

async function getProjects() {
  const snapshot = await getDocs(query(collection(db, 'projects')));
  freeTierMonitor.recordRead(1); // Record this read
  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function createProject(project: any) {
  const docRef = await addDoc(collection(db, 'projects'), project);
  freeTierMonitor.recordWrite(1); // Record this write
  return docRef;
}

async function deleteProject(projectId: string) {
  await deleteDoc(doc(db, 'projects', projectId));
  freeTierMonitor.recordDelete(1); // Record this delete
}
```

### In Components (Display Usage)

```typescript
// In any component that needs to show usage
import { freeTierMonitor } from '@/services/freeTierMonitor';

export function UsageDashboard() {
  const stats = freeTierMonitor.getStats();
  const hourlyRate = freeTierMonitor.getHourlyRate();
  const warnings = freeTierMonitor.getWarnings();

  return (
    <div>
      <h3>Today's Usage</h3>
      <p>Reads: {stats.daily.reads} / 50,000</p>
      <p>Writes: {stats.daily.writes} / 20,000</p>
      
      <h3>Projected Monthly</h3>
      <p>Reads: {hourlyRate.projectedMonthlyReads}</p>
      <p>Cost: ${hourlyRate.projectedMonthlyCost}</p>
      
      {warnings.map(w => <div className="alert">{w}</div>)}
    </div>
  );
}
```

### Getting Usage Statistics

```typescript
// In stores, hooks, or services
import { freeTierMonitor } from '@/services/freeTierMonitor';

// Get comprehensive stats
const stats = freeTierMonitor.getStats();
console.log(stats);
// {
//   monthly: { reads: 1234, writes: 567, deletes: 89, timestamp: ... },
//   daily: { date: "2025-01-15", reads: 45, writes: 23, deletes: 5 },
//   freeTierRemaining: { reads: 48766, writes: 19433, deletes: 19911 },
//   estimatedCost: 0.0, // $0 if within free tier
//   percentageUsed: { reads: "2.47%", writes: "2.84%", deletes: "0.45%" }
// }

// Get hourly rate and projections
const rates = freeTierMonitor.getHourlyRate();
console.log(rates);
// {
//   readsPerDay: "45",
//   writesPerDay: "23",
//   deletesPerDay: "5",
//   projectedMonthlyReads: "1350",
//   projectedMonthlyCost: "$0.00",
//   willExceedFreeTier: {
//     reads: false,
//     writes: false,
//     deletes: false
//   }
// }

// Get warnings
const warnings = freeTierMonitor.getWarnings();
warnings.forEach(w => console.warn(w));
// Warnings only show when usage > 80% of limit
```

## Free Tier Limits Reference

| Operation | Free Tier | Cost After | Notes |
|-----------|-----------|-----------|-------|
| Reads | 50,000/month | $0.06 per million | Cache hits don't count |
| Writes | 20,000/month | $0.18 per million | Includes updates |
| Deletes | 20,000/month | $0.02 per million | Bulk deletes = 1 per doc |
| Storage | 1 GB | $0.18 per GB | Backup: data + indexes |

## Monitoring Best Practices

### 1. Enable in App Root
```typescript
// App.tsx
import { freeTierMonitor } from '@/services/freeTierMonitor';

// This runs automatically on app load
// It logs current stats and any warnings
// Check browser console to see initial stats
```

### 2. Create a Settings Component
```typescript
// components/settings/UsageMonitor.tsx
import { freeTierMonitor } from '@/services/freeTierMonitor';

export function UsageMonitor() {
  const [stats, setStats] = useState(freeTierMonitor.getStats());
  
  useEffect(() => {
    const interval = setInterval(() => {
      setStats(freeTierMonitor.getStats());
    }, 60000); // Update every minute
    
    return () => clearInterval(interval);
  }, []);
  
  return (
    <div className="p-4 bg-blue-50 rounded">
      <h3 className="font-bold">Free Tier Usage</h3>
      <div className="mt-2 space-y-1 text-sm">
        <div>Reads: {stats.daily.reads} today</div>
        <div>Writes: {stats.daily.writes} today</div>
        <div>Projected: {stats.percentageUsed.reads} of monthly reads</div>
      </div>
    </div>
  );
}
```

### 3. Alert on Threshold
```typescript
// Hook to check limits periodically
export function useFreeTierWarnings() {
  useEffect(() => {
    const warnings = freeTierMonitor.getWarnings();
    if (warnings.length > 0) {
      console.warn('‚ö†Ô∏è Free Tier Warnings:');
      warnings.forEach(w => console.warn(w));
      
      // You could also show a toast/alert to the user
    }
  }, []);
}
```

### 4. Reset Monthly Stats
```typescript
// Every month, reset stats
// Add to a maintenance task or call manually

// Option 1: Manual reset in console
freeTierMonitor.resetMonthlyStats();

// Option 2: Automatic reset (first day of month)
if (new Date().getDate() === 1) {
  freeTierMonitor.resetMonthlyStats();
}
```

## Integration Checklist

### Phase 1: Services (This Week)
- [ ] projectService.ts - Add recording after getDocs/addDoc/updateDoc/deleteDoc
- [ ] userService.ts - Add recording after getDocs/addDoc/updateDoc/deleteDoc
- [ ] documentService.ts - Add recording after getDocs/addDoc/updateDoc/deleteDoc
- [ ] Test that stats appear in browser localStorage under "firebase-usage-stats"

### Phase 2: Components (Next Week)
- [ ] Create UsageMonitorComponent in components/settings/
- [ ] Add to Dashboard for quick view
- [ ] Setup warning alerts/toasts

### Phase 3: Dashboard (Following Week)
- [ ] Create comprehensive usage dashboard page
- [ ] Show daily/monthly trends
- [ ] Export stats as CSV/JSON
- [ ] Setup email alerts at 80% threshold

## Expected Results After Integration

With full integration of monitoring and optimization services:

**Before Optimization:**
- Estimated reads: 500K+/day ‚ùå (10x over limit)
- Estimated monthly cost: $30+ (overage charges)
- App would be shut down mid-month

**After Optimization:**
- Reads: ~100K/day with caching ‚úÖ (2x limit)
- With aggressive pagination: ~50K/day ‚úÖ (at limit)
- Estimated cost: $0 (stays within free tier)
- Sustainable for 3+ months

## Troubleshooting

### Stats Not Showing
1. Check browser dev console for startup messages
2. Verify `freeTierMonitor` is imported in App.tsx
3. Check localStorage: `window.localStorage.getItem('firebase-usage-stats')`

### Stats Resetting
- LocalStorage gets cleared when browser cache is cleared
- Add server-side backup: sync stats to Firestore daily (in background)
- Consider IndexedDB for persistence

### Inaccurate Counts
- Some libraries (like React Query) may cache reads
- Manually inspect each service for getDocs calls
- Use Chrome DevTools Network tab to verify Firestore calls

## Next Steps

1. **Integrate monitoring into all services** (projectService, userService, documentService)
2. **Create usage dashboard** visible in settings page
3. **Setup automatic alerts** when approaching 80% limit
4. **Add server-side tracking** via Cloud Functions (optional)
5. **Create weekly usage reports** for team awareness

---

Last Updated: 2025-01-15
Phase: 3/10 of Firebase Free Tier Optimization
