# HIS Integration Services - API Documentation

Complete documentation for all HIS integration services and components.

## Table of Contents

1. [Data Synchronization](#data-synchronization)
2. [Change Data Capture](#change-data-capture)
3. [Data Mapping](#data-mapping)
4. [Audit Logging](#audit-logging)
5. [Webhook Management](#webhook-management)
6. [React Hooks](#react-hooks)
7. [UI Components](#ui-components)

---

## Data Synchronization

### HISDataSyncService

Main service for coordinating bidirectional data synchronization between local system and HIS.

```typescript
import { HISDataSyncService } from '@/services/hisIntegration';

const syncService = new HISDataSyncService();
```

#### Methods

##### startSync(configId: string): Promise<SyncResult>

Initiates synchronization for a specific HIS configuration.

```typescript
const result = await syncService.startSync('config-123');
// {
//   success: true,
//   syncedRecords: 150,
//   duration: 5234
// }
```

**Parameters:**
- `configId` (string): The HIS configuration ID to sync

**Returns:** Promise<SyncResult>
- `success` (boolean): Whether sync completed successfully
- `syncedRecords` (number): Total records synchronized
- `duration` (number): Sync duration in milliseconds

**Throws:** HISError on failure

---

##### stopSync(configId: string): Promise<void>

Gracefully stops an active synchronization.

```typescript
await syncService.stopSync('config-123');
```

---

##### syncAll(parallel?: boolean): Promise<SyncResult[]>

Synchronize all enabled configurations.

```typescript
const results = await syncService.syncAll(false); // Sequential
const results = await syncService.syncAll(true);  // Parallel
```

**Parameters:**
- `parallel` (boolean, default: false): Run syncs in parallel or sequentially

**Returns:** Promise<SyncResult[]> - Results for each configuration

---

##### pullData(configId: string): Promise<FHIRResource[]>

Fetch data from HIS system.

```typescript
const data = await syncService.pullData('config-123');
```

**Returns:** Promise<FHIRResource[]> - Array of resources from HIS

---

##### pushData(configId: string, data: FHIRResource[]): Promise<void>

Send local data to HIS system.

```typescript
await syncService.pushData('config-123', [patient, observation]);
```

---

##### detectConflicts(local: FHIRResource, remote: FHIRResource): Promise<Conflict[]>

Detect conflicts between local and remote data versions.

```typescript
const conflicts = await syncService.detectConflicts(localPatient, remotePatient);
```

**Conflict Detection Strategy:**
- Compares timestamps (most recent wins)
- Compares checksums (structural changes)
- Identifies field-level differences

---

##### resolveConflict(conflictId: string, strategy: 'last-write-wins' | 'merge' | 'manual', resolution?: any): Promise<boolean>

Apply conflict resolution strategy.

```typescript
// Last-write-wins strategy
await syncService.resolveConflict('conflict-123', 'last-write-wins');

// Merge arrays/objects
await syncService.resolveConflict('conflict-456', 'merge');

// Manual resolution
await syncService.resolveConflict('conflict-789', 'manual', customValue);
```

**Strategies:**
- `last-write-wins`: Keep most recent modification
- `merge`: Intelligently merge non-conflicting fields
- `manual`: Apply custom resolution value

---

#### Configuration

```typescript
interface HISConfig {
  id: string;
  name: string;
  type: HISType; // EPIC, CERNER, HL7, MEDIDATA, GENERIC_REST, GENERIC_FHIR
  enabled: boolean;
  baseUrl: string;
  authType: AuthType;
  authConfig: Record<string, any>;
  mappingConfig?: DataMappingConfig;
  syncSchedule?: string; // Cron pattern
}
```

---

## Change Data Capture

### ChangeDataCaptureService

Tracks data modifications and syncs only delta changes to improve efficiency.

```typescript
import { changeDataCaptureService } from '@/services/hisIntegration';
```

#### Methods

##### recordCreate(resource: FHIRResource): ChangeRecord

Record creation of a new resource.

```typescript
const change = changeDataCaptureService.recordCreate(newPatient);
```

---

##### recordUpdate(resource: FHIRResource): ChangeRecord

Record modification of an existing resource. Automatically detects delta by comparing with previous snapshot.

```typescript
const change = changeDataCaptureService.recordUpdate(updatedPatient);
```

---

##### recordDelete(resource: FHIRResource): ChangeRecord

Record deletion of a resource.

```typescript
const change = changeDataCaptureService.recordDelete(deletedPatient);
```

---

##### getUnsyncedChanges(resourceType?: string, limit?: number): ChangeRecord[]

Get all changes that haven't been synchronized yet.

```typescript
// All unsynced changes
const changes = changeDataCaptureService.getUnsyncedChanges();

// Unsynced Patient changes, limited to 100
const patientChanges = changeDataCaptureService.getUnsyncedChanges('Patient', 100);
```

---

##### markAsSynced(changeIds: string[], syncedAt?: Date): number

Mark changes as synchronized. Returns count of marked changes.

```typescript
const count = changeDataCaptureService.markAsSynced(['change-123', 'change-456']);
```

---

##### getDeltaChanges(previous: FHIRResource, current: FHIRResource): DeltaChange[]

Calculate field-level differences between two versions.

```typescript
const deltas = changeDataCaptureService.getDeltaChanges(oldData, newData);
// [
//   {
//     field: 'birthDate',
//     previousValue: '1990-01-01',
//     newValue: '1990-01-02',
//     type: 'value'
//   }
// ]
```

---

##### applyDeltaChanges(resource: FHIRResource, deltas: DeltaChange[]): FHIRResource

Apply delta changes to a resource. Updates metadata automatically.

```typescript
const updated = changeDataCaptureService.applyDeltaChanges(patient, deltas);
```

---

##### getStatistics(): Statistics

Get overview of all changes.

```typescript
const stats = changeDataCaptureService.getStatistics();
// {
//   totalChanges: 1543,
//   syncedChanges: 1200,
//   unsyncedChanges: 343,
//   creates: 234,
//   updates: 1089,
//   deletes: 220,
//   byResourceType: [...]
// }
```

---

## Data Mapping

### DataMappingService

Handles bidirectional field mapping and transformations between local and HIS formats.

```typescript
import { dataMappingService } from '@/services/hisIntegration';
```

#### Methods

##### createMapping(mapping: FieldMapping): FieldMapping

Create a field mapping between local and HIS field names.

```typescript
const mapping = dataMappingService.createMapping({
  localField: 'firstName',
  hisField: 'name.0.given.0',
  resourceType: 'Patient',
  direction: 'both',
  required: true,
  transformIn: (val) => val?.trim(),
  transformOut: (val) => val?.toUpperCase()
});
```

**Mapping Configuration:**
- `localField`: Path to local field (dot notation)
- `hisField`: Path to HIS field (dot notation)
- `resourceType`: FHIR resource type
- `direction`: 'both', 'pull' (HIS→Local), or 'push' (Local→HIS)
- `transformIn`: Function to transform HIS value to local format
- `transformOut`: Function to transform local value to HIS format
- `required`: Whether field must be present
- `validation`: Custom validation function

---

##### transformInbound(hisData: FHIRResource, resourceType: string): Record<string, any>

Transform HIS data to local format using configured mappings.

```typescript
const localPatient = dataMappingService.transformInbound(fhirPatient, 'Patient');
```

---

##### transformOutbound(localData: Record<string, any>, resourceType: string): Partial<FHIRResource>

Transform local data to HIS format.

```typescript
const fhirPatient = dataMappingService.transformOutbound(localPatient, 'Patient');
```

---

##### validateData(data: Record<string, any>, resourceType: string): ValidationResult

Validate data against mapping requirements.

```typescript
const { valid, errors } = dataMappingService.validateData(patientData, 'Patient');

if (!valid) {
  console.error('Validation errors:', errors);
  // ['Required field missing: firstName', ...]
}
```

---

##### getMappingPreview(sourceData, resourceType, direction): MappingPreview

Preview transformation results and identify unmapped fields.

```typescript
const preview = dataMappingService.getMappingPreview(hisData, 'Patient', 'inbound');
// {
//   source: {...},
//   target: {...},
//   unmappedFields: ['telecom.1.use', 'address.1']
// }
```

---

##### mergeData(hisData, localData, resourceType, strategy): Record<string, any>

Merge HIS and local data using conflict resolution strategy.

```typescript
const merged = dataMappingService.mergeData(hisPatient, localPatient, 'Patient', 'merge');
```

**Strategies:**
- `'his'`: Use HIS data
- `'local'`: Keep local data
- `'merge'`: Intelligently merge

---

#### Built-in Mappings

Default mappings for common FHIR resources:

**Patient:**
- `firstName` ↔ `name.0.given.0`
- `lastName` ↔ `name.0.family`
- `dateOfBirth` ↔ `birthDate`
- `email` ↔ `telecom.0.value`

**Observation:**
- `value` ↔ `valueQuantity.value`
- `unit` ↔ `valueQuantity.unit`
- `observedAt` ↔ `effectiveDateTime`

---

## Audit Logging

### AuditLoggingService

Provides comprehensive audit trail for compliance, security, and debugging.

```typescript
import { auditLoggingService } from '@/services/hisIntegration';

// Set user context
auditLoggingService.setCurrentUser('user-123');
```

#### Methods

##### log(event: AuditEvent): AuditEvent

Log a custom audit event.

```typescript
const event = auditLoggingService.log({
  action: 'SYNC',
  resourceType: 'Patient',
  resourceId: 'pat-123',
  status: 'SUCCESS',
  details: { recordCount: 150, duration: 5234 }
});
```

---

##### logSuccess(action, resourceType, resourceId, details?, duration?)

Log successful operation.

```typescript
auditLoggingService.logSuccess('SYNC', 'Patient', 'pat-123', { recordCount: 150 }, 5234);
```

---

##### logFailure(action, resourceType, resourceId, errorMessage, details?, duration?)

Log failed operation.

```typescript
auditLoggingService.logFailure(
  'SYNC',
  'Patient',
  'pat-123',
  'Connection timeout',
  { retryCount: 3 }
);
```

---

##### logChange(action, resourceType, resourceId, before?, after?)

Log data change for compliance tracking.

```typescript
auditLoggingService.logChange(
  'UPDATE',
  'Patient',
  'pat-123',
  { firstName: 'John' },
  { firstName: 'Jane' }
);
```

---

##### getEvents(filter?): AuditEvent[]

Retrieve audit events with optional filtering.

```typescript
// All events from last 7 days
const events = auditLoggingService.getEvents({
  from: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
});

// Failed syncs by specific user
const failures = auditLoggingService.getEvents({
  userId: 'user-123',
  action: 'SYNC',
  status: 'FAILURE'
});
```

---

##### generateReport(from: Date, to: Date): AuditReport

Generate comprehensive audit report for compliance.

```typescript
const report = auditLoggingService.generateReport(
  new Date('2025-01-01'),
  new Date('2025-01-31')
);
// {
//   id: 'report-...',
//   generatedAt: Date,
//   period: { from, to },
//   events: [...],
//   statistics: {
//     totalEvents: 1234,
//     successfulEvents: 1200,
//     failedEvents: 34,
//     ...
//   }
// }
```

---

##### getResourceHistory(resourceType: string, resourceId: string): HistoryEntry[]

Get complete change history for a resource.

```typescript
const history = auditLoggingService.getResourceHistory('Patient', 'pat-123');
// [
//   {
//     event: {...},
//     before: { firstName: 'John' },
//     after: { firstName: 'Jane' }
//   },
//   ...
// ]
```

---

##### detectAnomalies(lookbackDays?): Anomaly[]

Detect suspicious activity patterns.

```typescript
const anomalies = auditLoggingService.detectAnomalies(7);
// [
//   {
//     type: 'REPEATED_FAILURES',
//     description: 'User X had 10 failed operations',
//     events: [...]
//   }
// ]
```

---

##### exportAuditLog(format?, filter?): string

Export audit log for external compliance systems.

```typescript
// Export as JSON
const json = auditLoggingService.exportAuditLog('json');

// Export as CSV with filters
const csv = auditLoggingService.exportAuditLog('csv', {
  from: new Date('2025-01-01'),
  status: 'FAILURE'
});
```

---

## Webhook Management

### WebhookManagerService

Manages bidirectional webhooks for real-time HIS event notifications.

```typescript
import { webhookManagerService } from '@/services/hisIntegration';
```

#### Methods

##### registerWebhook(config: WebhookConfig): WebhookConfig

Register a webhook to receive notifications.

```typescript
const webhook = webhookManagerService.registerWebhook({
  url: 'https://example.com/webhooks/his',
  events: ['patient.created', 'observation.updated'],
  active: true,
  secret: 'webhook-secret-key',
  retryPolicy: {
    maxRetries: 3,
    backoffMultiplier: 2,
    initialDelayMs: 1000
  }
});
```

---

##### emitEvent(eventType: string, payload: Record<string, any>): Promise<string[]>

Emit an event to all matching webhooks.

```typescript
const deliveredWebhooks = await webhookManagerService.emitEvent(
  'patient.created',
  {
    patientId: 'pat-123',
    name: 'John Doe',
    mrn: '00123456'
  }
);
```

---

##### testWebhook(webhookId: string): Promise<TestResult>

Test webhook connectivity.

```typescript
const result = await webhookManagerService.testWebhook('webhook-123');
// {
//   success: true,
//   responseTime: 245
// }
```

---

##### getWebhookHealth(webhookId: string): HealthStatus

Get health status of a webhook.

```typescript
const health = webhookManagerService.getWebhookHealth('webhook-123');
// {
//   status: 'healthy' | 'degraded' | 'unhealthy',
//   lastCheck: Date,
//   successRate: 99.5,
//   averageResponseTime: 234
// }
```

---

##### getWebhookStats(webhookId?: string): Statistics

Get delivery statistics.

```typescript
const stats = webhookManagerService.getWebhookStats('webhook-123');
// {
//   totalEvents: 5000,
//   deliveredEvents: 4950,
//   failedEvents: 25,
//   successRate: 99
// }
```

---

## React Hooks

### useSync

Hook for syncing HIS data.

```typescript
import { useSync } from '@/hooks/useHISIntegration';

function MyComponent() {
  const { isSyncing, syncProgress, lastSyncTime, syncError, startSync, stopSync } = useSync('config-123');

  return (
    <div>
      <button onClick={startSync} disabled={isSyncing}>Start Sync</button>
      <progress value={syncProgress} max={100} />
      {syncError && <p>Error: {syncError.message}</p>}
    </div>
  );
}
```

---

### useSyncSchedule

Hook for managing sync schedules.

```typescript
function MyComponent() {
  const { scheduledJobs, scheduleSync, unscheduleSync, pauseJob } = useSyncSchedule();

  return (
    <div>
      {scheduledJobs.map(job => (
        <div key={job.id}>
          <h4>{job.configId}</h4>
          <button onClick={() => pauseJob(job.id)}>Pause</button>
          <button onClick={() => unscheduleSync(job.id)}>Delete</button>
        </div>
      ))}
    </div>
  );
}
```

---

### useSyncHistory

Hook for accessing sync history and logs.

```typescript
function MyComponent() {
  const { logs, filterStatus, setFilterStatus, getLogStats } = useSyncHistory('config-123');
  const stats = getLogStats();

  return (
    <div>
      <p>Success Rate: {stats.successCount}/{stats.totalLogs}</p>
      <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}>
        <option value="">All</option>
        <option value="success">Success</option>
        <option value="error">Error</option>
      </select>
      {logs.map(log => <p key={log.id}>{log.message}</p>)}
    </div>
  );
}
```

---

### useSyncStatus

Hook for monitoring sync status.

```typescript
const status = useSyncStatus('config-123');

if (status?.isSyncing) {
  return <p>Syncing... {status.progress}%</p>;
}
```

---

### useBulkSync

Hook for bulk synchronization operations.

```typescript
const { bulkSyncInProgress, bulkProgress, syncAll } = useBulkSync();

return (
  <button onClick={() => syncAll(false)} disabled={bulkSyncInProgress}>
    Sync All ({bulkProgress}%)
  </button>
);
```

---

## UI Components

### SyncProgressBar

Displays real-time progress of HIS data synchronization.

```typescript
import { SyncProgressBar } from '@/components/his-integration';

<SyncProgressBar
  configId="config-123"
  autoStart={false}
  onComplete={() => console.log('Done!')}
  onError={(error) => console.error(error)}
  showDetails={true}
/>
```

---

### SyncScheduleManager

Create and manage sync schedules.

```typescript
import { SyncScheduleManager } from '@/components/his-integration';

<SyncScheduleManager />
```

**Features:**
- Create cron-based schedules
- Quick presets (15 min, hourly, daily, etc.)
- Pause/Resume jobs
- Delete schedules
- View upcoming runs

---

### ConflictResolver

UI for resolving data conflicts.

```typescript
import { ConflictResolver } from '@/components/his-integration';

<ConflictResolver
  configId="config-123"
  onResolved={() => console.log('Conflict resolved!')}
/>
```

**Features:**
- View conflicting values side-by-side
- Apply resolution strategies
- Manual resolution with custom values
- Batch resolve multiple conflicts

---

### IntegrationDashboard

Master dashboard with 3 tabs: Configurations, Status & Health, Activity Log.

```typescript
import { IntegrationDashboard } from '@/components/his-integration';

<IntegrationDashboard />
```

---

## Error Handling

All services throw standardized HIS errors:

```typescript
import { HISError } from '@/services/hisIntegration/integrations/ErrorHandler';

try {
  await syncService.startSync('config-123');
} catch (error) {
  if (error instanceof HISError) {
    console.error(error.code); // HIS_CONNECTION_ERROR
    console.error(error.message);
    console.error(error.details);
  }
}
```

**Error Types:**
- `HISConnectionError`: Network/connection issues
- `HISAuthenticationError`: Auth/credential problems
- `HISDataError`: Data validation/integrity issues
- `HISConfigurationError`: Configuration problems
- `HISSyncError`: Sync-specific errors

---

## Best Practices

1. **Always set user context for audit logging:**
   ```typescript
   auditLoggingService.setCurrentUser(getCurrentUserId());
   ```

2. **Use bulk sync sparingly:**
   ```typescript
   // Bad: Blocks UI during sync
   await syncService.syncAll(false);

   // Better: Run in background with progress
   const results = await syncService.syncAll(true);
   ```

3. **Monitor webhook health regularly:**
   ```typescript
   const health = webhookManagerService.getWebhookHealth(webhookId);
   if (health.successRate < 95) {
     // Alert and investigate
   }
   ```

4. **Archive old audit logs:**
   ```typescript
   const deleted = auditLoggingService.clearOldEvents(
     new Date(Date.now() - 90 * 24 * 60 * 60 * 1000) // 90 days ago
   );
   ```

5. **Validate before mapping:**
   ```typescript
   const validation = dataMappingService.validateData(data, 'Patient');
   if (validation.valid) {
     const mapped = dataMappingService.transformOutbound(data, 'Patient');
   }
   ```

---

## Examples

### Complete Sync Workflow

```typescript
const syncService = new HISDataSyncService();
const mappingService = dataMappingService;
const changeService = changeDataCaptureService;
const auditService = auditLoggingService;

// 1. Set audit context
auditService.setCurrentUser('admin-user');

// 2. Start sync
const syncStart = Date.now();
const result = await syncService.startSync('epic-prod');

// 3. Get unsynced changes
const unsyncedChanges = changeService.getUnsyncedChanges();

// 4. Log results
auditService.logSuccess('SYNC', 'Patient', 'batch', {
  recordCount: result.syncedRecords,
  changeCount: unsyncedChanges.length
}, Date.now() - syncStart);

console.log('Sync complete:', result);
```

### Conflict Resolution Workflow

```typescript
// 1. Detect conflicts
const conflicts = await syncService.detectConflicts(localData, hisData);

// 2. Resolve automatically when possible
for (const conflict of conflicts) {
  if (conflict.canAutoResolve) {
    await syncService.resolveConflict(conflict.id, 'last-write-wins');
  }
}

// 3. Get remaining conflicts for manual review
const remaining = conflicts.filter(c => !c.canAutoResolve);
console.log(`${remaining.length} conflicts require manual intervention`);
```

---

## Version

- **API Version:** 1.0.0
- **Last Updated:** January 2025
- **Compatible With:** React 18+, TypeScript 5.0+

