import React, { useState } from 'react';
import { useAppStore } from '@/stores/useAppStore';
import { useTranslation } from '@/hooks/useTranslation';
import { useTheme } from "@/components/common/ThemeProvider";
import SettingsCard from "./SettingsCard";
import SettingsButton from "./SettingsButton";
import SettingsAlert from "./SettingsAlert";
import SettingsSection from "./SettingsSection";
import { useToast } from "@/hooks/useToast";
import ToggleSwitch from "./ToggleSwitch";
import { labelClasses } from "@/components/ui/constants";
import { CheckIcon, SunIcon, MoonIcon, ExclamationTriangleIcon } from "@/components/icons";
import {
  SettingsPanel,
  FormGroup,
  AdvancedToggle,
  EnhancedSelect,
} from "./index";

const AppearanceSettingsPage: React.FC = () => {
  const { t } = useTranslation();
  const toast = useToast();
  const { theme, toggleTheme } = useTheme();
  const { appSettings, updateAppSettings } = useAppStore();

  const [appearance, setAppearance] = useState({
    compactMode: appSettings?.appearance?.compactMode ?? false,
    sidebarCollapsed: appSettings?.appearance?.sidebarCollapsed ?? false,
    showAnimations: appSettings?.appearance?.showAnimations ?? true,
    cardStyle: (appSettings?.appearance?.cardStyle ?? "elevated") as
      | "elevated"
      | "outlined"
      | "filled",
  });

  const [loading, setLoading] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);

  const handleAppearanceChange = (
    updater: (prev: typeof appearance) => typeof appearance
  ) => {
    const newAppearance = updater(appearance);
    setAppearance(newAppearance);
    setHasChanges(
      JSON.stringify(newAppearance) !==
        JSON.stringify(appSettings?.appearance || appearance)
    );
  };

  const handleSave = async () => {
    setLoading(true);
    try {
      await updateAppSettings({
        ...appSettings!,
        appearance,
      });

      if (appearance.compactMode) {
        document.documentElement.classList.add("compact-mode");
      } else {
        document.documentElement.classList.remove("compact-mode");
      }

      if (appearance.showAnimations) {
        document.documentElement.classList.remove("reduce-motion");
      } else {
        document.documentElement.classList.add("reduce-motion");
      }

      setHasChanges(false);
      toast.success(t("settingsUpdated"));
    } catch (error) {
      toast.error(t("settingsUpdateFailed"));
    } finally {
      setLoading(false);
    }
  };

  const handleCancel = () => {
    setAppearance({
      compactMode: appSettings?.appearance?.compactMode ?? false,
      sidebarCollapsed: appSettings?.appearance?.sidebarCollapsed ?? false,
      showAnimations: appSettings?.appearance?.showAnimations ?? true,
      cardStyle: (appSettings?.appearance?.cardStyle ?? "elevated") as
        | "elevated"
        | "outlined"
        | "filled",
    });
    setHasChanges(false);
  };

  return (
    <div className="space-y-6">
      {hasChanges && (
        <SettingsAlert
          type="warning"
          icon={ExclamationTriangleIcon}
          title={t("unsavedChanges")}
          message={t("youHaveUnsavedChanges") || "You have unsaved changes to your settings"}
          onDismiss={() => {}}
        />
      )}

      <SettingsCard
        title={t("appearance")}
        description={t("appearanceDescription")}
      >
        <div className="space-y-8">
          {/* Theme Mode Section */}
          <SettingsSection
            title={t("themeMode") || "Theme Mode"}
            description={
              t("themeModeDescription") ||
              "Choose between light and dark mode for the application"
            }
          >
            <div className="flex items-center gap-4">
              <button
                onClick={() => theme === "dark" && toggleTheme()}
                className={`flex-1 flex items-center justify-center gap-3 p-4 rounded-lg border-2 transition-all ${
                  theme === "light"
                    ? "border-brand-primary bg-brand-primary/5 dark:bg-brand-primary/10"
                    : "border-gray-300 dark:border-gray-600 hover:border-brand-primary/50"
                }`}
                aria-pressed={theme === "light"}
              >
                <SunIcon
                  className={`w-6 h-6 ${
                    theme === "light"
                      ? "text-brand-primary"
                      : "text-gray-400 dark:text-gray-500"
                  }`}
                />
                <div className="text-left">
                  <div
                    className={`font-medium ${
                      theme === "light"
                        ? "text-brand-primary"
                        : "text-gray-700 dark:text-gray-300"
                    }`}
                  >
                    {t("lightMode") || "Light Mode"}
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">
                    {t("lightModeDesc") || "Bright theme for daytime"}
                  </div>
                </div>
                {theme === "light" && (
                  <CheckIcon className="w-5 h-5 text-brand-primary ml-auto" />
                )}
              </button>

              <button
                onClick={() => theme === "light" && toggleTheme()}
                className={`flex-1 flex items-center justify-center gap-3 p-4 rounded-lg border-2 transition-all ${
                  theme === "dark"
                    ? "border-brand-primary bg-brand-primary/5 dark:bg-brand-primary/10"
                    : "border-gray-300 dark:border-gray-600 hover:border-brand-primary/50"
                }`}
                aria-pressed={theme === "dark"}
              >
                <MoonIcon
                  className={`w-6 h-6 ${
                    theme === "dark"
                      ? "text-brand-primary"
                      : "text-gray-400 dark:text-gray-500"
                  }`}
                />
                <div className="text-left">
                  <div
                    className={`font-medium ${
                      theme === "dark"
                        ? "text-brand-primary"
                        : "text-gray-700 dark:text-gray-300"
                    }`}
                  >
                    {t("darkMode") || "Dark Mode"}
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">
                    {t("darkModeDesc") || "Dark theme for low light"}
                  </div>
                </div>
                {theme === "dark" && (
                  <CheckIcon className="w-5 h-5 text-brand-primary ml-auto" />
                )}
              </button>
            </div>
          </SettingsSection>

          <SettingsSection
            title={t("displayOptions") || "Display Options"}
            description="Customize display preferences"
          >
            <ToggleSwitch
              label={t("compactMode")}
              description={t("compactModeDescription")}
              enabled={appearance.compactMode}
              setEnabled={() =>
                handleAppearanceChange((a) => ({
                  ...a,
                  compactMode: !a.compactMode,
                }))
              }
            />

            <ToggleSwitch
              label={t("collapseSidebar")}
              description={t("collapseSidebarDescription")}
              enabled={appearance.sidebarCollapsed}
              setEnabled={() =>
                handleAppearanceChange((a) => ({
                  ...a,
                  sidebarCollapsed: !a.sidebarCollapsed,
                }))
              }
            />
          </SettingsSection>

          <SettingsSection
            title={t("animation")}
            description="Animation and motion preferences"
          >
            <ToggleSwitch
              label={t("showAnimations")}
              description={t("showAnimationsDescription")}
              enabled={appearance.showAnimations}
              setEnabled={() =>
                handleAppearanceChange((a) => ({
                  ...a,
                  showAnimations: !a.showAnimations,
                }))
              }
            />
          </SettingsSection>

          <div>
            <label htmlFor="cardStyle" className={labelClasses}>
              {t("cardStyle")}
            </label>
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-3">
              {t("cardStyleDescription")}
            </p>
            <select
              id="cardStyle"
              value={appearance.cardStyle}
              onChange={(e) =>
                handleAppearanceChange((a) => ({
                  ...a,
                  cardStyle: e.target.value as
                    | "elevated"
                    | "outlined"
                    | "filled",
                }))
              }
              className="mt-1 w-full max-w-xs border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary sm:text-sm bg-white dark:bg-gray-700 dark:text-white"
            >
              <option value="elevated">{t("elevated")}</option>
              <option value="outlined">{t("outlined")}</option>
              <option value="filled">{t("filled")}</option>
            </select>
          </div>

          <div className="mt-8 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
            <h4 className="text-sm font-medium text-gray-900 dark:text-white mb-3">
              {t("preview")}
            </h4>
            <div
              className={`p-4 rounded-lg ${
                appearance.cardStyle === "elevated"
                  ? "shadow-md bg-white dark:bg-gray-800"
                  : appearance.cardStyle === "outlined"
                  ? "border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800"
                  : "bg-gray-100 dark:bg-gray-700"
              }`}
            >
              <p className="text-sm text-gray-700 dark:text-gray-300">
                {t("previewCardText")}
              </p>
            </div>
          </div>
        </div>
      </SettingsCard>

      <div className="flex gap-3 justify-end">
        <SettingsButton
          variant="secondary"
          onClick={handleCancel}
          disabled={!hasChanges || loading}
        >
          {t("cancel")}
        </SettingsButton>
        <SettingsButton
          variant="primary"
          onClick={handleSave}
          disabled={!hasChanges || loading}
          loading={loading}
          icon={!loading && hasChanges ? CheckIcon : undefined}
        >
          {loading ? t("saving") : t("saveChanges")}
        </SettingsButton>
      </div>
    </div>
  );
};

export default AppearanceSettingsPage;
